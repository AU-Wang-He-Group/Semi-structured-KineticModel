# Semi-structured-KineticModel - Model framework to predict the coculture growth under a wide range of growth conditions 

![alt text](https://github.com/AU-Wang-He-Group/Semi-structured-KineticModel/blob/main/Output/Graphical%20abstract.jpg?raw=true)


This repository contains code and experimental data for running the Semi-structured kinetic modeling for methanotroph-photoautotroph (M-P) cocultures (2021) 

This model has been implemented and tested with a series of designed experiments using *Methylomicrobium buryatense* 5GB1- *Arthrospira platensis*,
and it is expected to be applicable to other coculture systems with different species or varieties.


# 1. Folder structure

- __Code__: codes of the model for different conditions
- __Experimental Data__: all the data from the experiments used in the modeling (all analyzed data are embeded in codes as well)
- __Output__: figures generated by the model for some conditions 

![warning-icon](https://img.icons8.com/emoji/48/000000/warning-emoji.png)
__WARNING__: functionV7 needs to be downloaded to run the codes at different conditions- all codes are similar with the same variables and just initial conditions at each code are different.


# 2. Experimental Data folder structure

The Experimental Data folder includes the following files:

- __Exp.Data__: contains the individual biomass concentration and also the individual substrate consumption and product excretion rates.
   - all this set of data has been analyzed using an experimental-computational (E-C) protocol developed by our group: (URL: https://onlinelibrary.wiley.com/doi/full/10.1002/bit.27603).

   - _Different conditions_: five different series of experiments has been carried out in this work.
   1-Coculture 2-single culture 3-Gas composition 4-Light intensity 5-Inoculum ratio
     
   The discription of each file and the corresponding experiment are included in the following table:

   |File name                                 |Description                           |
   |------------------------------------------|--------------------------------------|
   |_Exp.Data_Coculture-Singleculture_        |the coculture and single cultures growth experiments  |
   |_Exp.Data_GasComposition_                 |the effect of the gas phase composition on the coculture growth     |
   |_Exp.Data_lightIntensity_                 |the effect of different light intensities on the coculture growth   |
   |_Exp.Data_InoculumRatio_                  |the effect of different inoculum ratio on the coculture growth     |
 

![info-icon](https://img.icons8.com/flat_round/48/000000/info.png)
__NOTE__: photoautotroph has been specified with Green color and methanotroph with Orange color 
   to make reading the excel file easier.


- __Raw.Data__: contains measurements of each sample points for all experiments.
   - these data will not be used in the code directly and it is just has been provided as additional information.
   - raw data of the measurements included:
      - Optical density (OD 670)
      - Inorganic carbon concentration (IC) (mg/L)
      - Gas area and concentrations using Gas Chromatography (GC) for -Oxygen (O2) -Methane (CH4) -Carbon dioxide (CO2)


# 3. Code folder structure

- User can produce all figures available in the paper: 

- In order to make it clear, we use the following table to introduce each file:

![Table1](https://user-images.githubusercontent.com/67964457/122443411-2f786d00-cf65-11eb-9ea3-8d64c39a4b36.jpg)

- __Matlab codes__: The discription of each file and the corresponding simulation are included in the following table:

   |File name                                 |Description                           |
   |------------------------------------------|--------------------------------------|
   |_CocultureVsSingle_        | To reproduce the analysis of Case A and Case E |
   |_GasComposition_                 |To reproduce the analysis of Case C     |
   |_LightIntensity_                 |To reproduce the analysis of Case B   |
   |_InoculumRatio_                  |To reproduce the analysis of Case D     |
   |_functionV7_                  |the function used for runnig all above codes     |
   |_WithoutSelfShad_                  |A code for investigating the absence of self-shading effect     |
   |_functionWO_                  |the function used with _WithoutSelfShad_ file     |
   
![warning-icon](https://img.icons8.com/emoji/48/000000/warning-emoji.png)
__WARNING__: Function file needs to be downloaded to run the codes at different conditions.


## 3.1. How to read the codes
- Flowchart of semi-structure modeling of the M-P coculture: 

 ![image](https://user-images.githubusercontent.com/67964457/122436706-a827fb00-cf5e-11eb-9c9e-f56282463082.png)


- The structure of the codes has been shown in the following subsections:

### 3.1.1. Experimental data

each code has been started with the experimental section, which is copied from analyzed experimental data (__Exp.Data__).

![warning-icon](https://img.icons8.com/emoji/48/000000/warning-emoji.png)
__WARNING__: If you wish to use your own data start by cleaning each one of the variables in _Experimental data_ section in the code: 
Further explanation about -Name- of each variable has been provided inside the codes.


### 3.1.2. Parameters for running

_PRODUCTIVITY_TABLE_NAME_
Annual productivity table as a CSV file

_RESP_VAR_FIELD_NAME_
Name of the field/column with annual/multi-annual productivity data. 
This column should be inside the table located in the DATA/ProductivityData folder

_REGION_ID_FIELD_NAME_
Name of the field that contains the region unique identifier code 
(an ineteger values). This code must be the same used in the region raster 
file inside the DATA/Regions folder.

_REGION_NAME_FIELD_NAME_
Field/column name containing the region names

_IS_MULTI_YEAR_
Is productivity data multi-annual? If TRUE the annual data will be firstly 
aggregated using the average and then used as input for regression with SDM 
suitable area as predictor

_YEAR_FIELD_NAME_
Name of the field/column with the reference year. 

_SDM_RST_BAND_INDEX_
Raster band index to use from each species binary SDM. This represents
which combination of ensemble measure / threshold metric is used to construct
the species/variey raster stack. The file has a total of 9 bands which represent the
two-factor combination of: (1) average ensemble, (2) median ensemble, and (3)
the weighted average ensemble vs. (A) TSS threshold, (B) ROC threshold and, (C)
Kappa threshold. The 9 bands are in the following order: 1A, 1B, 1C, 2A, 2B, 2C,
3A, 3B, 3C.

_COORD_SYSTEM_
Coordinate system of the data (must be the same for species records and
predictor variables in raster format). The projection name is a PROJ4-like string.
The default is set to WGS 1984 geographic coordinate system
Set as NULL if not needed or if data already has a defined coordinate system.

_PROJ_RASTER_DATA_
Set this to  TRUE if the raster data needs to be re-projected to a different
coordinate reference system as to allow area calculations. This may be required if
the original data is in a geographic coordinate system.
Set to FALSE if data does not require a re-projection to a projected system.

_PROJ_COORD_SYSTEM_
A CRS PROJ4 string that will be used to re-project the raster input data.

_RST_SPATIAL_RES_
Spatial resolution (pixel size) to attribute to the re-projected raster 
(usually in meters)

_VERBOSE_
Print progress messages? If TRUE messages and progress bars will be displayed.


### 3.1.3. Outputs 

Outputs from biomod2 will be placed onto _OUTPUTS/MODS_. Inside this, one directory for 
each modelled species/variety will appear. Inside each species folder, projection results 
will appear in directories labelled with a _proj__ prefix where spatial results can be cheched 
more easily in any GIS software (or R) using results in the _GeoTIFF_ subfolder. 

Each calibrated model object are located in the _models_ subfolder. Do not change nor delete this 
folder as this will make recovering or reusing modelling objects impossible.

Model evaluation scores are displayed in csv files with the suffixes:

-  _evalDF_KAPPA.csv_: Kappa scores for partial models
-  _evalDF_TSS.csv_: TSS scores for partial models
-  _evalDF_ROC.csv_: ROC scores for partial models
- _EnsMod_evalDF_AllMetrics.csv_: final scores for the ensemble model containing 
TSS, ROC and Kappa metrics as well as the threshold applied to "binarize" models, 
along with sensitivity and specificity values.

Variable importance score are displayed in a csv folder with suffix _varImportance.csv_


## 3.2. Fitting the log-log productivity model

### 3.2.1. Inputs

Three main inputs are required to run this script:

(i) A set of modeling outputs placed in the OUTPUTS/MODS folder and  generated
By the SDMcalibrationForecasting-v1.R script.

(ii) Total Annual productivity data (either single or multi-year) by region of interest
formatted as a csv table placed in the DATA/productivityData folder. This table should
contain the following fields/columns:
    (a) region names
    (b) region unique ID codes (in integer values)
    (c) year
    (d) annual production

(iii) A GeoTIFF Raster file with region data. Each region is identified by an
integer value, the same used as the unique ID in the Total Annual productivity
table. This is necessary to enable joining the data across these sources. To
enable area calculations this should be in a projected coordinate system or  (check
below PROJ_RASTER_DATA and PROJ_COORD_SYSTEM parameter).


### 3.2.2. Parameters for running

_PRODUCTIVITY_TABLE_NAME_
Annual productivity table as a CSV file

_RESP_VAR_FIELD_NAME_
Name of the field/column with annual/multi-annual productivity data.
This column should be inside the table located in the DATA/ProductivityData folder

_REGION_ID_FIELD_NAME_
Name of the field that contains the region unique identifier code
(an ineteger values). This code must be the same used in the region raster
file inside the DATA/Regions folder.

_REGION_NAME_FIELD_NAME_
Field/column name containing the region names

_IS_MULTI_YEAR_
Is productivity data multi-annual? If TRUE the annual data will be firstly
aggregated using the average and then used as input for regression with SDM
suitable area as predictor

_YEAR_FIELD_NAME_
Name of the field/column with the reference year.

_SDM_RST_BAND_INDEX_
Raster band index to use from each species binary SDM. This represents
which combination of ensemble measure / threshold metric is used to construct
the species/variey raster stack. The file has a total of 9 bands which represent the
two-factor combination of: (1) average ensemble, (2) median ensemble, and (3)
the weighted average ensemble vs. (A) TSS threshold, (B) ROC threshold and, (C)
Kappa threshold. The 9 bands are in the following order: 1A, 1B, 1C, 2A, 2B, 2C,
3A, 3B, 3C.

_COORD_SYSTEM_
Coordinate system of the data (must be the same for species records and
predictor variables in raster format). The projection name is a PROJ4-like string.
The default is set to WGS 1984 geographic coordinate system
Set as NULL if not needed or if data already has a defined coordinate system.

_PROJ_RASTER_DATA_
Set this to  TRUE if the raster data needs to be re-projected to a different
coordinate reference system as to allow area calculations. This may be required if
the original data is in a geographic coordinate system.
Set to FALSE if data does not require a re-projection to a projected system.

_PROJ_COORD_SYSTEM_
A CRS PROJ4 string that will be used to re-project the raster input data.

_RST_SPATIAL_RES_
Spatial resolution (pixel size) to attribute to the re-projected raster
(usually in meters)

_VERBOSE_
Print progress messages? If TRUE messages and progress bars will be displayed.


### 3.2.3 Outputs

Model outputs will be placed the _OUTPUTS/PROD_MODS_ directory. 

A multiband raster with all species binary projections (0/1, unsuitable/suitable) 
in files with suffix _SpBinEnvSuit.tif_ and its total overlap in _AllSpBinEnvSuit.tif_.

Also includes model summaries and diagnostics for the log-log annual production model 
by region.


# 4. Contacts

If you need assistance using these analysis scripts or to adjust them to your specific aims, 
do contact us at:

_Salvador Arenas-Castro_: salvadorarenascastro [at] cibio.up.pt

_João F Gonçalves_: joao.goncalves [at] cibio.up.pt
# Semi-structured-KineticModel
*This Kinetic model consist of 4 main Models to run, including the experimental data:

1-Coculture vs single culture 2-Gas composition 3-Light intensity 4-Inoculum ratio

-which all the models use the same function named "functionV7".

*There is an addtional model to test the coculture growth without havind the self shading effect:

Withoutselfshed -which uses "functionWO" to operate.
Wang group May 2021
